# OpenDuo CI/CD Pipeline
#
# - Runs security tests on every push
# - On tags: creates a GitLab release and updates the Homebrew formula SHA

stages:
  - test
  - secret-detection
  - release

# --- Security scanning (from templates) ---
sast:
  stage: test
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
variables:
  SECRET_DETECTION_ENABLED: "true"
secret_detection:
  stage: secret-detection

# --- Unit tests ---
test:
  stage: test
  image: oven/bun:1
  script:
    - bun install
    - bun test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# --- Auto-release: sync version, tag, update formula ---
# Runs on main when commit message matches Renovate's pattern.
# Uses a deploy key / CI token that can push to the repo.
auto-release:
  stage: release
  image: oven/bun:1
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl git
    - git config user.email "ci@gitlab.com"
    - git config user.name "OpenDuo CI"
    # Use CI token for push access
    - git remote set-url origin "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git checkout main
    - git pull origin main
  script:
    - chmod +x script/release.sh
    - bash script/release.sh
  rules:
    # Only run when Renovate updates opencode-ai on main
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
      changes:
        - bun.lock
      when: manual
      allow_failure: true

# --- Create GitLab release on tags ---
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "OpenDuo ${CI_COMMIT_TAG}"
    description: |
      ## Installation

      ```bash
      brew tap vglafirov/openduo https://gitlab.com/vglafirov/openduo.git
      brew install openduo
      ```

      ## What's included
      - OpenCode dependency: see package.json for pinned version
      - Restricted models catalog (GitLab provider only)
      - Security hardening: sharing disabled, models locked down
