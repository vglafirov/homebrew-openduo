# OpenDuo CI/CD Pipeline
#
# - Runs security tests on every push
# - On tags: creates a GitLab release and updates the Homebrew formula SHA

stages:
  - test
  - secret-detection
  - release

# --- Security scanning (from templates) ---
sast:
  stage: test
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
variables:
  SECRET_DETECTION_ENABLED: "true"
secret_detection:
  stage: secret-detection

# --- Unit tests ---
test:
  stage: test
  image: oven/bun:1
  script:
    - bun install
    - bun test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# --- Create GitLab release on tags ---
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "OpenDuo ${CI_COMMIT_TAG}"
    description: |
      ## Installation

      ```bash
      brew tap vglafirov/openduo https://gitlab.com/vglafirov/openduo.git
      brew install openduo
      ```

      ## What's included
      - OpenCode dependency: see package.json for pinned version
      - Restricted models catalog (GitLab provider only)
      - Security hardening: sharing disabled, models locked down
